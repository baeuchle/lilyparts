#!/bin/bash

for D in $*; do
    d=${D/.ly/}
    d=$(echo $d | sed 's/\/$//')
    b=$(basename $d)
    # Normale Version:
    # (wir löschen später alles, was mit midirm aufhört)
    lilypond -dmidi-extension=midirm $d.ly;
    mv $b-.pdf $b.pdf
    # MIDI-Version (wir löschen nachher auch das ps)
    lilypond --ps -dmidi-extension=midi -e '(define makeMidi #t)' $d.ly;
    mv $b-midi.midi $b.midi
    # Stimmen:
    namen=(a Eins Zwei Drei Vier Bass Drum Okta Elec Quer Saxo Saxb)
    for s in $(seq 1 $(((${#namen[@]}-1)))); do
        has="has${namen[$s]}";
        show="show${namen[$s]}";
        echo "Stimme $s ${namen[$s]}";
        if [ "$(grep -q $has $d.ly; echo $?)" == "0" ]; then
            lilypond -dmidi-extension=midirm -e "(begin (define showAlle #f) (define $show #t))" "$d.ly";
        fi;
    done;
    rm $b*midirm;
    rm $b-midi.ps
done
