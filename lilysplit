#!/bin/bash

includedir="$(dirname $0)"
if [ -x "$(which lilypond)" ]; then
    echo ""
else
    echo "Lilypond not found, please install" >&2
    exit 1;
fi

lilyver=""
if [ -x "$(which git)" ]; then
    cd $includedir;
    lilyver="$(git describe --tags --dirty --always)"
    lilyver="${lilyver/v/l}"
    cd - >/dev/null
fi

LILYOPTS=" --include $includedir --loglevel=BASIC "
nomidi="-dmidi-extension=midirm"
echo -e "Starting \033[1mlilysplit\033[0m using \033[1;32m$lilyver\033[0m"

for D in $*; do
    d=${D/.ly/}
    d=$(echo $d | sed 's/\/$//')
    b=$(basename $d)
    # look for version information for each lilypond file separately:
    if [ -x "$(which git)" ]; then
        cd $(dirname $d)
        version="$(git describe --tags --dirty --always)"
        cd - > /dev/null
    else
        version=""
    fi
    echo -e "Compiling \033[1m$d\033[0m, Version \033[1;32m$version\033[0m"
    whatwedoinfo="(\033[4m$d\033[0m \033[4;32m$version $lilyver\033[0m)"
    # Normale Version:
    # (wir löschen später alles, was mit midirm aufhört)
    echo -e "\033[1;34mComplete Score\033[0m $whatwedoinfo"
    lilypond $LILYOPTS $nomidi -e "(begin (define lilyver \"$lilyver\") (define gitver \"$version\"))" $d.ly;
    if [ $? -eq 1 ]; then
      echo -e "\033[1;31mCompilation failed!\033[0m"
      continue;
    fi
    mv $b-.pdf $b.pdf
    # MIDI-Version (wir löschen nachher auch das ps)
    echo -e "\033[1;34mMidi Version\033[0m $whatwedoinfo"
    lilypond $LILYOPTS --ps -dmidi-extension=midi -e "(begin (define lilyver \"$lilyver\") (define gitver \"$version\") (define makeMidi #t))" $d.ly;
    if [ $? -eq 1 ]; then
      echo -e "\033[1;31mCompilation failed!\033[0m"
      continue;
    fi
    mv $b-midi.midi $b.midi
    # Stimmen:
    namen=(unused Eins Zwei Drei Vier Bass Drum Okta Elec Quer Saxo Saxb)
    for s in $(seq 1 $(((${#namen[@]}-1)))); do
        has="has${namen[$s]}";
        show="show${namen[$s]}";
        if [ "$(grep -q $has $d.ly; echo $?)" == "0" ]; then
            echo -e "\033[1;34mExcerpt $s\033[0m: \033[0;32m${namen[$s]}\033[0m $whatwedoinfo"
            lilypond $LILYOPTS $nomidi -e "(begin (define lilyver \"$lilyver\") (define gitver \"$version\") (define showAlle #f) (define $show #t))" "$d.ly";
            if [ $? -eq 1 ]; then
              echo -e "\033[1;31mCompilation failed!\033[0m"
              break;
            fi
        else
            echo -e "\033[31mNo excerpt $s\033[0m: \033[0;35m${namen[$s]}\033[0m"
        fi;
    done;
    rm $b*midirm;
    rm $b-midi.ps
done
